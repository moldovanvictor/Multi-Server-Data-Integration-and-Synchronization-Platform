<html>
<head>
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script type="application/javascript" id="bloc"></script>
    <script type="application/javascript" id="bloc2"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
    <script>
        br = document.createElement('br');
        const csrfToken = document.querySelector( 'meta[name="csrf-token"]' ).getAttribute('content');
        axios.defaults.headers.common['X-CSRF-TOKEN'] = csrfToken;
        function cerere() {
            blocJS = document.getElementById("bloc");
            blocJS.src = "http://127.0.0.1:8000/jsonLdScraping?callback=procesareRaspuns";
        }
        function createFirstTable(date) {
            tinta = document.getElementById("tinta");
            table = document.createElement('table');
            table.setAttribute('border', '1');
            thead = document.createElement('thead');
            headerRow = document.createElement('tr');
            headers = ['Nume Pozitie', 'Descriere Pozitie', 'Data Postarii', 'Data Expirarii', 'Tip Contract', 'Nume Firma', 'Adresa'];
            headers.forEach(function (header) {
                th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            tbody = document.createElement('tbody');
            date['@graph'].forEach( function(job) {
                row = document.createElement('tr');
                tdNumePozitie = document.createElement('td');
                    tdNumePozitie.textContent = job.title;
                    tdDescriere = document.createElement('td');
                    tdDescriere.textContent = job.description;
                    tdDataPostarii = document.createElement('td');
                    tdDataPostarii.textContent = job.datePosted;
                    tdDataExpirarii = document.createElement('td');
                    tdDataExpirarii.textContent = job.validThrough;
                    tdTipContract = document.createElement('td');
                    tdTipContract.textContent = job.employmentType;
                    row.appendChild(tdNumePozitie);
                    row.appendChild(tdDescriere);
                    row.appendChild(tdDataPostarii);
                    row.appendChild(tdDataExpirarii);
                    row.appendChild(tdTipContract);
                    tbody.appendChild(row);
                    job.hiringOrganization.forEach( function ( firma ) {
                        tdNumeFirma = document.createElement('td');
                        tdNumeFirma.textContent = firma.name;
                        tdAdresa = document.createElement('td');
                        tdAdresa.textContent = firma.address;
                        row.appendChild(tdNumeFirma);
                        row.appendChild(tdAdresa);
                    } );
            } );
            table.appendChild(tbody);
            tinta.appendChild(table);
        }
        function createFirstForm(date) {
            form = document.createElement('form');
            form.setAttribute('id', 'toRdf4j');
            form.setAttribute( 'method', 'POST' );
            form.style.border = '1px solid black';
            form.style.display = 'inline-block';
            form.style.width = 'auto';
            labelName = document.createElement('label');
            labelName.setAttribute('for', 'firme');
            labelName.textContent = 'Nume Firma:   ';
            form.appendChild(labelName);
            inputFirme = document.createElement('input');
            inputFirme.setAttribute( 'type', 'text' );
            inputFirme.setAttribute('name', 'firme');
            inputFirme.setAttribute('id', 'firme');
            form.appendChild(inputFirme);
            form.appendChild(document.createElement('br'));
            labelAddress = document.createElement( 'label' );
            labelAddress.setAttribute('for', 'adresa');
            labelAddress.textContent = "Adresa Firma:   ";
            form.appendChild( labelAddress );
            inputAddress = document.createElement( 'input' );
            inputAddress.setAttribute( 'type', 'text' );
            inputAddress.setAttribute('name', 'adresa');
            inputAddress.setAttribute('id', 'adresa');
            form.appendChild( inputAddress );
            labelPozitie = document.createElement( 'label' );
            labelPozitie.setAttribute( 'for', 'title' );
            labelPozitie.textContent = 'Pozitie:   ';
            form.appendChild(document.createElement('br'));
            form.appendChild( labelPozitie );
            dropdownPozitie = document.createElement( 'select' );
            dropdownPozitie.setAttribute( 'id', 'title' );
            date['@graph'].forEach( function( pozitie ) {
                option = document.createElement('option');
                option.text = pozitie.title;
                dropdownPozitie.add(option);
            } );
            form.appendChild( dropdownPozitie );
            form.appendChild(document.createElement('br'));
            toRdfBUtton = document.createElement('input');
            toRdfBUtton.setAttribute('type', 'button');
            toRdfBUtton.setAttribute('onclick', 'trimiteCatreRdf4j('+JSON.stringify( date )+')');
            toRdfBUtton.setAttribute('value', 'Trimite Catre RDF4J');
            form.appendChild(toRdfBUtton);
            
            tinta.appendChild(form);
        }
        function procesareRaspuns(date) {
            createFirstTable(date);
            createFirstForm(date);
        }
        
        function createLastTable( dateGraphQl ) {
            tinta = document.getElementById('tinta');
            tinta.appendChild( br );
            table = document.createElement('table');
            table.setAttribute('border', '1');
            thead = document.createElement('thead');
            headerRow = document.createElement('tr');
            headers = ['Nume Pozitie', 'Descriere Pozitie', 'Data Postarii', 'Data Expirarii', 'Tip Contract', 'Nume Firma', 'Adresa'];
            headers.forEach(function (header) {
                th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            tbody = document.createElement('tbody');
            for ( index in dateGraphQl['allJobPostings'] ) {
                for ( let i = 0; i < dateGraphQl['allJobPostings'][index]['hiringOrganization'].length; i++ ) {
                    row = document.createElement('tr');
                    tdNumePozitie = document.createElement('td');
                    tdNumePozitie.textContent = dateGraphQl['allJobPostings'][index]['title'];
                    tdDescriere = document.createElement('td');
                    tdDescriere.textContent = dateGraphQl['allJobPostings'][index]['description'];
                    tdDataPostarii = document.createElement('td');
                    tdDataPostarii.textContent = dateGraphQl['allJobPostings'][index]['datePosted'];
                    tdDataExpirarii = document.createElement('td');
                    tdDataExpirarii.textContent = dateGraphQl['allJobPostings'][index]['validThrough'];
                    tdTipContract = document.createElement('td');
                    tdTipContract.textContent = dateGraphQl['allJobPostings'][index]['employmentType'];
                    tdNumeFirma = document.createElement('td');
                    tdNumeFirma.textContent = dateGraphQl['allJobPostings'][index]['hiringOrganization'][i]['name'];
                    tdAdresa = document.createElement('td');
                    tdAdresa.textContent = dateGraphQl['allJobPostings'][index]['hiringOrganization'][i]['address'];
                    row.appendChild(tdNumePozitie);
                    row.appendChild(tdDescriere);
                    row.appendChild(tdDataPostarii);
                    row.appendChild(tdDataExpirarii);
                    row.appendChild(tdTipContract);
                    row.appendChild(tdNumeFirma);
                    row.appendChild(tdAdresa);
                    tbody.appendChild(row);
                }
            }
            table.appendChild( tbody );
            tinta.appendChild( table );
            butonToAi = document.createElement( 'input' );
            butonToAi.setAttribute( 'type', 'button' );
            butonToAi.setAttribute( 'onclick', 'trimiteDateAi()' );
            butonToAi.setAttribute( 'value', 'Trimite date la OpenAI' );
            document.getElementById('tinta').appendChild( br );
            document.getElementById('tinta').appendChild( butonToAi );
        }

        function preiaDateGraphQl() {
            obiectInterogare = {
                query : "{ allJobPostings { title description datePosted validThrough employmentType hiringOrganization } }"
            }
            textInterogare = JSON.stringify( obiectInterogare );
            axios.post("http://127.0.0.1:8000/getGraphQl", textInterogare)
            .then(( response ) => {
                console.log( response );
                createLastTable( response['data']['data'] );
            } )
            .catch( ( error ) => console.log( error ) );
        }

        function trimiteDateGraphql( dateGraphQl ) {
            axios.post("http://127.0.0.1:8000/sendToGraphQl", dateGraphQl)
            .then((response) => {
                console.log( response );
                console.log( response['data'] );
                butonGetGraphql = document.createElement( 'input' );
                butonGetGraphql.setAttribute( 'type', 'button' );
                butonGetGraphql.setAttribute( 'onclick', 'preiaDateGraphQl()' );
                butonGetGraphql.setAttribute( 'value', 'Preia date de la GraphQL' );
                document.getElementById('tinta').appendChild( br );
                document.getElementById('tinta').appendChild( butonGetGraphql );
            })
            .catch((error) => console.log(error));
        }
        
        function procesareDateRdf4j(dateRdf4j) {
            tinta = document.getElementById("tinta");
            table = document.createElement('table');
            table.setAttribute('border', '1');
            thead = document.createElement('thead');
            headerRow = document.createElement('tr');
            headers = ['Nume Pozitie', 'Descriere Pozitie', 'Data Postarii', 'Data Expirarii', 'Tip Contract', 'Nume Firma', 'Adresa'];
            headers.forEach(function (header) {
                th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            tbody = document.createElement('tbody');
            dateRdf4j.forEach( function( o ) {
                if ( o['@type'] && o['@type'] == 'https://schema.org/JobPosting' ) {
                    for ( let i = 0; i < o['https://schema.org/hiringOrganization'].length; i++ ) {
                        row = document.createElement('tr');
                        tdNumePozitie = document.createElement('td');
                        tdNumePozitie.textContent = o['https://schema.org/title'][0]['@value'];
                        tdDescriere = document.createElement('td');
                        tdDescriere.textContent = o['https://schema.org/description'][0]['@value'];
                        tdDataPostarii = document.createElement('td');
                        tdDataPostarii.textContent = o['https://schema.org/datePosted'][0]['@value'];
                        tdDataExpirarii = document.createElement('td');
                        tdDataExpirarii.textContent = o['https://schema.org/validThrough'][0]['@value'];
                        tdTipContract = document.createElement('td');
                        tdTipContract.textContent = o['https://schema.org/employmentType'][0]['@value'];
                        firmaObj = dateRdf4j.find( x => x['@id'] === o['https://schema.org/hiringOrganization'][i]['@id'] );
                        tdNumeFirma = document.createElement('td');
                        tdNumeFirma.textContent = firmaObj['https://schema.org/name'][0]['@value'];
                        tdAdresa = document.createElement('td');
                        tdAdresa.textContent = firmaObj['https://schema.org/address'][0]['@value']
                        row.appendChild(tdNumePozitie);
                        row.appendChild(tdDescriere);
                        row.appendChild(tdDataPostarii);
                        row.appendChild(tdDataExpirarii);
                        row.appendChild(tdTipContract);
                        row.appendChild(tdNumeFirma);
                        row.appendChild(tdAdresa);
                        tbody.appendChild(row);
                    }  
                }
                // console.log( o );
            } );
            console.log( dateRdf4j.find( x => x['@id'] === 'http://victor-vlad.ro/uipath' ) );
            console.log( dateRdf4j[6] );
            console.log( dateRdf4j[6]['@id'] );
            console.log( dateRdf4j[6]['https://schema.org/name'][0]['@value'] );
            console.log( dateRdf4j[6]['https://schema.org/address'][0]['@value'] );
            console.log( dateRdf4j[2]['https://schema.org/hiringOrganization'][0]['@id'] );
            table.appendChild(tbody);
            tinta.appendChild( table );
            butonToGraphql = document.createElement( 'input' );
            butonToGraphql.setAttribute( 'type', 'button' );
            butonToGraphql.setAttribute( 'onclick', 'trimiteDateGraphql('+ JSON.stringify( dateRdf4j ) +')' );
            butonToGraphql.setAttribute( 'value', 'Trimite date la GraphQL' );
            document.getElementById('tinta').appendChild( br );
            document.getElementById('tinta').appendChild( butonToGraphql );
            
        }

        function preiaDateRdf4j() {
            axios.get( "http://127.0.0.1:8000/getRdf4j" )
            .then( (response) => {
                procesareDateRdf4j( response.data );
            } )
            .catch((error) => console.log(error));
        }
        function trimiteCatreRdf4j(date) {
            firmeValue = document.getElementById( 'firme' ).value;
            adresaValue = document.getElementById( 'adresa' ).value;
            pozitieValue = document.getElementById( 'title' ).value;
            pozitieToAppend = date['@graph'].find( job => job['title'] === pozitieValue );
            jsonToAppend = {
                "@type": "Organization",
                "@id": "x:"+firmeValue.toLowerCase(),
                "name": firmeValue,
                "address": adresaValue
            };
            pozitieToAppend.hiringOrganization.push( jsonToAppend );
            
            
            axios.post("http://127.0.0.1:8000/sendToRdf4j", date)
            .then((response) => {
                butonGetRdf4j = document.createElement( 'input' );
                butonGetRdf4j.setAttribute( 'type', 'button' );
                butonGetRdf4j.setAttribute( 'onclick', 'preiaDateRdf4j()' );
                butonGetRdf4j.setAttribute( 'value', 'Preia date de la RDF4J' );
                document.getElementById('tinta').appendChild( br );
                document.getElementById('tinta').appendChild( butonGetRdf4j );
            })
            .catch((error) => console.log(error));
            
            
            
        }
        
    </script>
</head>
<body>
    <input type="button" onclick="cerere()" value="Declanseaza cerere" />
    <div id="tinta"></div> 
</body>
</html>
