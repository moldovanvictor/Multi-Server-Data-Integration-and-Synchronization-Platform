<html>
<head>
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script type="application/javascript" id="bloc"></script>
    <script type="application/javascript" id="bloc2"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
    <script>
        br = document.createElement('br');
        const csrfToken = document.querySelector( 'meta[name="csrf-token"]' ).getAttribute('content');
        axios.defaults.headers.common['X-CSRF-TOKEN'] = csrfToken;
        function cerere() {
            blocJS = document.getElementById("bloc");
            blocJS.src = "http://127.0.0.1:8000/jsonLdScraping?callback=procesareRaspuns";
        }
        function createFirstTable(date) {
            tinta = document.getElementById("tinta");
            table = document.createElement('table');
            table.setAttribute('border', '1');
            thead = document.createElement('thead');
            headerRow = document.createElement('tr');
            headers = ['Nume Pozitie', 'Descriere Pozitie', 'Data Postarii', 'Data Expirarii', 'Tip Contract', 'Nume Firma', 'Adresa'];
            headers.forEach(function (header) {
                th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            tbody = document.createElement('tbody');
            date['@graph'].forEach( function(job) {
                row = document.createElement('tr');
                tdNumePozitie = document.createElement('td');
                    tdNumePozitie.textContent = job.title;
                    tdDescriere = document.createElement('td');
                    tdDescriere.textContent = job.description;
                    tdDataPostarii = document.createElement('td');
                    tdDataPostarii.textContent = job.datePosted;
                    tdDataExpirarii = document.createElement('td');
                    tdDataExpirarii.textContent = job.validThrough;
                    tdTipContract = document.createElement('td');
                    tdTipContract.textContent = job.employmentType;
                    row.appendChild(tdNumePozitie);
                    row.appendChild(tdDescriere);
                    row.appendChild(tdDataPostarii);
                    row.appendChild(tdDataExpirarii);
                    row.appendChild(tdTipContract);
                    tbody.appendChild(row);
                    job.hiringOrganization.forEach( function ( firma ) {
                        tdNumeFirma = document.createElement('td');
                        tdNumeFirma.textContent = firma.name;
                        tdAdresa = document.createElement('td');
                        tdAdresa.textContent = firma.address;
                        row.appendChild(tdNumeFirma);
                        row.appendChild(tdAdresa);
                    } );
            } );
            table.appendChild(tbody);
            tinta.appendChild(table);
        }
        function createFirstForm(date) {
            form = document.createElement('form');
            form.setAttribute('id', 'toRdf4j');
            form.setAttribute( 'method', 'POST' );
            form.style.border = '1px solid black';
            form.style.display = 'inline-block';
            form.style.width = 'auto';
            labelName = document.createElement('label');
            labelName.setAttribute('for', 'firme');
            labelName.textContent = 'Nume Firma:   ';
            form.appendChild(labelName);
            inputFirme = document.createElement('input');
            inputFirme.setAttribute( 'type', 'text' );
            inputFirme.setAttribute('name', 'firme');
            inputFirme.setAttribute('id', 'firme');
            form.appendChild(inputFirme);
            form.appendChild(document.createElement('br'));
            labelAddress = document.createElement( 'label' );
            labelAddress.setAttribute('for', 'adresa');
            labelAddress.textContent = "Adresa Firma:   ";
            form.appendChild( labelAddress );
            inputAddress = document.createElement( 'input' );
            inputAddress.setAttribute( 'type', 'text' );
            inputAddress.setAttribute('name', 'adresa');
            inputAddress.setAttribute('id', 'adresa');
            form.appendChild( inputAddress );
            labelPozitie = document.createElement( 'label' );
            labelPozitie.setAttribute( 'for', 'title' );
            labelPozitie.textContent = 'Pozitie:   ';
            form.appendChild(document.createElement('br'));
            form.appendChild( labelPozitie );
            dropdownPozitie = document.createElement( 'select' );
            dropdownPozitie.setAttribute( 'id', 'title' );
            date['@graph'].forEach( function( pozitie ) {
                option = document.createElement('option');
                option.text = pozitie.title;
                dropdownPozitie.add(option);
            } );
            form.appendChild( dropdownPozitie );
            form.appendChild(document.createElement('br'));
            toRdfBUtton = document.createElement('input');
            toRdfBUtton.setAttribute('type', 'button');
            toRdfBUtton.setAttribute('onclick', 'trimiteCatreRdf4j('+JSON.stringify( date )+')');
            toRdfBUtton.setAttribute('value', 'Trimite Catre RDF4J');
            form.appendChild(toRdfBUtton);
            
            tinta.appendChild(form);
        }
        function procesareRaspuns(date) {
            createFirstTable(date);
            createFirstForm(date);
        }
        function preiaDateRdf4j() {
            axios.get( "http://127.0.0.1:8000/sendToRdf4j" )
            .then( (response) => {
                console.log( response.data );
            } );
            alert('ok');
        }
        function trimiteCatreRdf4j(date) {
            firmeValue = document.getElementById( 'firme' ).value;
            adresaValue = document.getElementById( 'adresa' ).value;
            pozitieValue = document.getElementById( 'title' ).value;
            pozitieToAppend = date['@graph'].find( job => job['title'] === pozitieValue );
            jsonToAppend = {
                "@type": "Organization",
                "@id": "x:"+firmeValue.toLowerCase(),
                "name": firmeValue,
                "address": adresaValue
            };
            pozitieToAppend.hiringOrganization.push( jsonToAppend );
            
            
            axios.post("http://127.0.0.1:8000/sendToRdf4j", date)
            .then((response) => {
                console.log(response.data);
                console.log( response.data.turtleData );
                butonGetRdf4j = document.createElement( 'input' );
                butonGetRdf4j.setAttribute( 'type', 'button' );
                butonGetRdf4j.setAttribute( 'onclick', 'preiaDateRdf4j()' );
                butonGetRdf4j.setAttribute( 'value', 'Preia date de la RDF4J' );
                document.getElementById('tinta').appendChild( br );
                document.getElementById('tinta').appendChild( butonGetRdf4j );
            })
            .catch((error) => console.log(error));
            
            
            
        }
        
    </script>
</head>
<body>
    <input type="button" onclick="cerere()" value="Declanseaza cerere" />
    <div id="tinta"></div> 
</body>
</html>
